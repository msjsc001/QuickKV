# QuickKV 更新日志

- ✔️1.2.0 重大更新：MVC 架构重构与体验优化
	- 架构全面升级为高度解耦的MVC模式，高度分解单一代码文件，底层更加健壮稳定。
	- 所有用户配置与缓存分离至独立的`用户数据/`文件夹，实现真正的文件隔离。
	- 移除原有多余的打包脚本与系统残留帮助文档，所有外置词库统一到自动载入文件夹管理。
	- 系统托盘菜单现在支持单击直接唤出主界面（与Ctrl+空格同效）。
	- 修复了首次启动同意协议对话框在黑暗模式下的色彩适配问题。

- ✔️1.0.5.41 修复：词库更新时及时读取内容
	- 加载的词库文件有更新或变动时，在搜索框搜索不出更新或变动的内容
- ✔️1.0.5.40 修复：搜索时剪贴板词库内容重复2次。 优化： ctrl+空格 后弹窗默认不再显示词库内容（极致性能考虑）。
	- 剪贴板记忆开启的时候搜索会出现两次相同内容
	- 另外如果是"剪贴板词库-勿删.md"的词右键不可再加入到 “剪贴板词库-勿删.md”
	- ctrl+空格 后弹窗默认不再显示词库内容（极致性能考虑）。
- ✔️1.0.5.39 声明与许可协议与帮助文档
	- ✔️1.0.5.39.1 声明与许可协议(变更版本、新设备首次运行都会提示，并内嵌在软件内的系统托盘菜单内)
		- 您同意协议后的设备ID，被记录在了与 程序 同一个目录下的`config.ini`文件中。
			- accepted_disclaimer_info = {"id": "一个哈希值", "version": "当前软件版本号"}
	- ✔️1.0.5.39.2 帮助文档
		- 使用一个本地的md和PDF文件，在系统托盘菜单"帮助"能打开它
- ✔️1.0.5.38 修复：剪贴板内容到词库的二次复制
- ✔️1.0.5.37 修复与优化：剪贴板开启后，搜索不到剪贴板的内容，修复并优化剪贴板词库位置。
- ✔️1.0.5.36.1 再优化高亮问题、匹配排序问题
- ✔️1.0.5.36 匹配算法打磨、🔴从pypinyin 库换用为 pypinyin-dict 库、重构缓存逻辑、重写搜索算法
	- 因为引用库有错误的多音字，有的错误匹配问题无法修复
	- pypinyin 库有罕见发音的多音“污染”所以换用pypinyin-dict库
- ✔️1.0.5.35 tab缩进距离远(一个TAB应该四个空格一样距离)
- ✔️1.0.5.34 🔴匹配内容高亮（多词多色）
- ✔️1.0.5.33 软件有版本更新时，自动重建 cache.json
- ✔️1.0.5.32 修复与优化：搜索匹配问题
  - 1、优化为**“动态评分制”模糊匹配算法**（VS Code所使用的）
    - **首字母奖励**、**连续匹配奖励**、**间隔惩罚**、**位置奖励**
  -  使缓存cache.json 与优化后的方案契合
  -  修复匹配不相关内容也匹配问题
- ✔️1.0.5.31 加固：进行防御性加固（稳定性加固）
  - **线程管理 (Threading)**: 程序中 `NativeHotkeyManager` 和 `ShortcutListener` 都在独立的线程中运行。如果线程启动、停止或异常处理不当，可能导致资源泄露或程序无法正常退出。
    - 确保热键和快捷码的后台监听线程能够被更安全、更干净地停止。
  - **文件 I/O (File Input/Output)**: 程序频繁读写配置文件、词库文件和缓存。如果文件被意外删除、损坏（例如，JSON格式错误）或无权限访问，程序可能会崩溃。
    - 确保程序在配置文件或缓存文件损坏时，能够优雅地处理并使用默认值启动，而不是直接崩溃。
  - **外部进程调用 (External Process)**: 通过 `PowerShell` 执行粘贴操作依赖于外部环境。如果 `PowerShell` 执行失败或被安全软件拦截，虽然不至于让主程序崩溃，但会导致功能失灵，我们可以增加日志来记录这类问题。
    - 确保调用 `PowerShell` 进行粘贴时，即使失败也不会影响主程序的稳定性。
  - **全局钩子 (Global Hooks)**: `pynput` 作为一个全局键盘监听器，如果其回调函数 `_on_press` 内部发生未捕获的异常，可能会导致监听线程停止工作，使得快捷码功能在用户无感知的情况下失效。
    - 确保回调函数中的任何错误都不会导致监听中断。
- ✔️1.0.5.30 修复：“记忆剪贴板”相关功能导致的系统高占用死机问题
  - 将剪贴板监控功能从有风险的“定时器轮询”模式重构为稳定高效的“事件驱动”模式。现在，程序只会在剪贴板内容真正发生变化时才做出反应，这从根本上解决了导致程序卡死的资源竞争问题。
- ✔️1.0.5.29 修复：搜索缓存带来的拼音首字和英文搜索分离的问题。
- ✔️1.0.5.28 修复：从剪贴板词库添加到别库的词条删除或编辑时失败的问题。
- 1.0.5.27.5 ✔️修复1：剪贴板功能记忆自己的输出 ✔️ 修复2："快捷码"和"不出现"语法同时用时互相不兼容。 ✔️优化：界面左上角软件名和版本号颜色弱化。✔️🔴1.0.5.27.5 优化：建立自动搜索缓存大词库响应瞬间完成。✔️优化：软件关闭后加强卸载钩子。
  - ✔️1.0.5.27.1“剪贴板文字记忆”记忆软件自己输出的内容
    - 问题，在开启系统托盘菜单“剪贴板文字记忆”功能后使用快捷键“ctrl+空格” 唤起软件界面 选择好词条输出内容 ，输出的内容会被“剪贴板文字记忆”记忆，“剪贴板文字记忆”不应该在任何情况下记忆QuickKV自己输出的内容，比如点击窗口界面词条的输出和在系统托盘菜单“开启快捷码”后用户使用快捷码的输出，都不应该被“剪贴板文字记忆”记忆。
    - 解决，程序主动向剪贴板写入内容后，临时“无视”一次由该写入操作引发的剪贴板变化。
  - ✔️1.0.5.27.2 问题，用输入行尾的功能性语法时功能冲突。
    - 在系统托盘菜单"开启快捷码"被开启时，词条内"快捷码"语法"`k:xxx`"在"`不出现`"语法前方,"快捷码"功能则会失效。
    - 改进：行尾的功能语法不管互相什么位置，应该互相兼容不冲突。
  - ✔️1.0.5.27.3 优化：另外关闭软件后加强卸载程序的键盘钩子，避免干扰系统。
  - ✔️1.0.5.27.4 优化：“ctrl+空格” 唤起软件界面 左上角的软件名和版本号的文字颜色，视觉上的弱化（白天和夜晚模式都是）使其更柔和。
  - ✔️1.0.5.27.5 优化：建立缓存，大大优化菜单搜索效率，使得搜索响应**接近瞬时完成**！**在加载词库时，程序会一次性计算好所有词条的拼音、小写等信息并存起来。搜索时直接使用，速度极快。** 并且自动检测到词库和词库内容有变动是根据变动内容精确的更新缓存。 建立cache.json文件进行缓存工作。
- 1.0.5.26 🔴新功能，**快捷码** `K:xxx`
  - 该功能**在系统托盘菜单默认关闭**
  - 加入了一个"`k:xxx`"语法
  - 这个"`k:xxx`"语法和 "`不出现`"一样需要在词条的行尾，是特定的一种功能识别。
  - "k:" 组合后的字母或字符等于会识别用户在键盘输入的字母或字符，字母大小写不敏感识别，大写小写都可。
    - 比如设定的是 "- 这是一个词条 `k:xxx` "，如果检测到用户键盘输入"xxx"后则直接输出"这是一个词条"文字。
    - 比如设定的是"- 这是词条内容 `k:23；` "，如果检测到用户键盘输入"23；"后则直接输出"这是词条内容"文字。
    - 如果有父子级的，则输出父子级，总之和正常选中词条输出功能一致，只是识别用户键盘输入用语法来完成的， `k:xxx` 这语法和其内容任何时候都是不输出的但用户可以灵活编辑。
- 1.0.5.25 修复：右键词条修改后点ok没任何改变。
- 1.0.5.24 修复：多音字的识别问题
  - 对中文多音字，软件里只会识别多音字的其中一个拼音首字母。现在每个字的多种音的首字母都能被识别出来。
- 1.0.5.23 修复：匹配问题
  - **所有**关键词要么都通过文本匹配成功，要么都通过拼音匹配成功。
  - **正确的逻辑应该是**：对于每一个关键词，只要它能通过**文本或拼音**中的任意一种方式匹配成功即可。
- 1.0.5.22  新功能：自定义快捷键
  - 在托盘菜单原“启用快捷键”选项下方新加一个“自定义快捷键”，用户点击“自定义快捷键”后能让用户能修改“ctrl+空格”
    - 请你帮我设计一个，点击“自定义快捷键”修改自定义快捷键的功能窗，其中有一个按钮“恢复ctrl+空格”在里边，其余的请你帮我设计好，不需要太复杂，简单能定义快捷键即可。
- 1.0.5.21 修复：主界面四角不透明问题
  - 1.0.5.21 修复：主界面四角不透明问题- 
- 1.0.5.20 修复：在输入框或界面选择菜单右键"添加词库"不能显示"自动载入的md词库"。
- 1.0.5.19 优化搜索结果，按最匹配排序
  - **完全匹配** 的词条排名最高。
  - **以查询词开头** 的词条排名靠前。
  - 与查询词**长度相近**的词条排名更靠前。
    - 优化长度惩罚机制，确保更短、更精确的匹配项获得更高的分数。
  - **拼音匹配**的结果权重会低于直接的文本匹配。
  - 剪贴板内容和词库平级

- 1.0.5.18 新加功能：“程序自动载入目录下特定文件夹MD词库，载入后可以有选择的选用”
  - 这个功能和现有的托盘菜单类的`词库选择`-`添加md词库`类似，只是不需要用户手动添加词库，在对应目录下的`.md`文件程序会自动添加。
  - 1、程序会自动识别载入根目录下`MD词库-需自动载入的请放入`文件夹内的`任意文件名`+`.md`后缀的文件为词库（后边称为`.md`文件）
    - 如果没有`MD词库-需自动载入的请放入`文件夹，程序会自动建立一个，程序每次启动时都会检查是否有这个文件夹。
    - 如果`MD词库-需自动载入的请放入`文件夹被用户添加进`.md`文件,就会被程序识别使用，并根监控变化。
  - 2、在系统托盘一级菜单`词库选择`位置下边加入一个`自动载入的md词库`菜单
    - 程序会自动识别`MD词库-需自动载入的请放入`文件夹里的`.md`文件载入到程序内作为词库使用，同时也会把识别到的`.md`文件载入到这个`自动载入的md词库`菜单内部，载入到`自动载入的md词库`菜单的词库就和`词库选择`-`添加md词库`功能一致具备同样的功能。
    - 如果`MD词库-需自动载入的请放入`文件夹内的`.md`文件没有了或被改名了，程序会自动去除这个系统托盘菜单`自动载入的md词库`菜单内部下的对应`.md`词库，如果有新加的则会自动新加入，加入后默认开启使用。
    - `自动载入的md词库`菜单内显示出来的词库菜单，每项前，都会有一个勾选框，用户可以勾选需要使用的，被勾选的会被开起使用，未勾选的则不会被使用。`自动载入的md词库`菜单内的词库菜单只有前边勾选框和文件名，没有其它选项。
    - `自动载入的md词库`菜单内部第一行为`打开-md词库文件夹`，用户点击后会打开`MD词库-需自动载入的请放入`文件夹。
    - 以上的操作和载入都会被程序记住设置。

- 1.0.5.17 修复：剪贴板记忆满后无法更新问题
- 1.0.5.16 优化UI：更柔和的调色
- 1.0.5.15 减法：去除意义不大的功能界面图钉、优化UI
  - 减法：取消图钉功能
  - UI：界面菜单加入分割线，使内容更易区分、加入版本号在界面左上角显示
- 1.0.5.14 加强：长词条删除时界面超出显示器外，加入滚动条。

- 1.0.5.13 加强：剪贴板文字记忆 内容被移动到新词库时 去除“剪贴板词库.md”

- 1.0.5.12 修复：启用剪贴板记忆时软件复制软内容会出现空行
  - 加强：软件输出默认使用ctrl+v，用户可选用ctrl+shift+v、ctrl+v、模拟打字

- 1.0.5.11 修复：启用剪贴板记忆时软件复制软内容会出现空行
  - 现在有一个新的问题也就是软件在我使用"剪贴板记忆"的时候复制“带有软换行的内容”或多行内容时会自动出现一些空行，使用统一 `\n` vs `\r\n`的方式修复

- 1.0.5.10 修复：图钉模式下，内容未贴好就转回程序
  - 让 PowerShell 采用“shift+ctrl+v”的方式来输入内容
  - 图钉模式时让焦点不回到界面，界面只做一个“调色板”。

- 1.0.5.9 修复：无法贴出内容、取消窗口在屏幕边缘上下翻
  -  **修复无法贴出内容**
     -  `ctypes`库能稳定的识别快捷键，但不能粘贴
     -  **通过 PowerShell 调用 .NET 的 `SendKeys` API 来执行粘贴**
  -  **取消窗口在屏幕边缘上下翻**

- 1.0.5.8 修复：快捷键重构
  -  **根本性修复**: 彻底重构了快捷键实现方式，弃用原有的 `keyboard` 库，改为使用 **Windows 原生 API (`RegisterHotKey`)** 进行全局热键注册。
     -  **解决了什么问题?** 解决了程序长时间运行后，因键盘钩子不稳定而导致的快捷键完全失效的核心问题。
     -  **带来了什么好处?**
     -  **极高的稳定性**: 新方案由操作系统直接调度，稳定可靠，不再需要“定时重建钩子”等临时性维护手段。
     -  **更高的效率**: 几乎零资源占用，仅在快捷键按下时才响应。
     -  **代码变更**: 所有与旧 `keyboard` 库相关的功能，包括“重建快捷键”菜单和定时器，均已被**彻底移除**，代码更精简、更健壮。

- 1.0.5.7 修复：三个问题
  -  修复了在开启剪贴板记忆功能后，无法搜索到剪贴板历史内容的问题。
  -  修复了对剪贴板历史条目右键时，缺失“添加到词库”选项的问题。
  -  修复了搜索窗口被唤起时，输入光标没有自动聚焦到搜索框的问题。

- 1.0.5.6 添加词库时需要选择库
  -  **功能增强**: 在输入框右键“添加到词库”时，如果存在多个词库，会弹出选择列表，让用户决定将新词条添加到哪个具体的 `.md` 文件中。

- 1.0.5.5 
  -  **新功能：快速打开词库**
     -  在“词库选择”菜单中，为每个词库增加了一个“打开”按钮，可以快速在文件浏览器中定位到该词库文件，方便编辑。

- 1.0.5.4 
  -  **新功能：增强稳定性**
     -  在系统托盘菜单中增加了“间隔时间自动重启”子菜单。
     -  用户可以启用/禁用此功能（默认关闭），并自由设定重启的间隔时间（默认3分钟）。
     -  提供“立即重启”选项，方便手动重启程序。
  -  **修复**
     -  优化了重启逻辑，确保重启命令能被正确执行。

- 1.0.5.3
  -  **新功能：剪贴板文字记忆**
     -  在系统托盘增加“剪贴板文字记忆”功能，默认关闭。
     -  用户可开启后，程序会自动记录剪贴板历史。在搜索框为空时，会优先展示剪贴板历史记录。
     -  支持自定义记忆条数（默认10条）和一键清空所有历史。
     -  剪贴板历史条目同样支持右键菜单，可将其“添加到词库”、进行“编辑”或“删除”。
     -  剪贴板历史被保存在独立的 `剪贴板词库.md` 文件中。

- 1.0.5.2
  -  **新功能：多词库支持**
     -  现在可以在“词库选择”菜单中添加任意多个 `.md` 文件作为词库。
     -  每个词库都可以被独立启用或禁用，方便用户根据场景切换词库。
     -  支持从菜单中直接移除词库（不会删除本地文件）。
     -  如果词库文件在本地被删除，程序会自动将其从列表中移除。

- 1.0.5.1
  -  **新功能：界面内词条管理**
     -  在搜索框和结果列表区域增加了右键上下文菜单。
     -  现在可以直接在输入框中输入内容后，右键选择“添加到词库”。
     -  可以直接右键点击结果列表中的词条，进行“编辑”或“删除”操作。
     -  编辑功能会弹出一个与主界面风格统一的文本编辑窗口。

- 1.0.4.1
  -  **修复与优化**
     -  引入了自动和手动的快捷键钩子重建机制，以解决程序长时间运行后快捷键失效的问题。

- 1.0.3
  -  1、取消"；"复制内容快捷键启动界面功能，因为会导致失焦，且实用意义不大
  -  2、系统托盘内添加了总开关（快捷键开关）

- 1.0.2 
  -  1、利用利用每个字的拼音首字母，进行搜索，的功能
     -  比如在输入框输入 拼音字母 “qd”就能找到“请定”之类的字，输入的越多匹配的也越精确（按理匹配的内容就越少），这个功能请给一个系统托盘的勾选框叫"拼音首字母匹配"，默认开启。"
  -  2、"；"复制内容快捷键启动界面
     -  如果用户点击"；"键（有时也是"；"），就使用 ctrl+shift+左键 的方法复制文本，复制后需要1次删除键去除选择的文本，因为文本后边会转移到输入框，而后自动开启软件界面填入复制的文本。这个功能请给一个系统托盘的勾选框叫"；键复制查询"默认开启。
     -  这个功能一般建议配合拼音首字母方法用。

- 1.0.1
  -  排序按字母整理（词库和搜索）
     -  词库和搜索结果内自动按前缀（名字）排序整理（中文会识别拼音首字母排序）
     -  避免了大量自加词后，词库和搜索可读性差的问题，
     -  词库排序整理 在软件关闭时检测到词库文件有变化后才会进行（用内容哈希校验），且**软件被关闭后**，这样避免和用户输入词库冲突，也为性能考虑。

- 1.0.0
  -  新功能
     -  版本提示
           	-  系统托盘菜单，加入版本标识 QuickKV_1.0.0
             	-  搜索：打空格多词包含搜索
           	-  也叫多关键词搜索，逻辑搜索 (AND Search)
     -  UI修改
             	-  托盘菜单和系统界面UI风格统一 1150
     -  修复bug
             	-  窗口 `ctrl+空格` 前置时无法切换日夜模式
             	-  修复无法窗口拖拽放大缩小
     -  构建
             	-  构建了win1.0版
